- name: Update and upgrade apt packages
  become: true
  apt:
    upgrade: yes
    update_cache: yes


- name: Install InfluxDB key
  get_url:
    url:  https://repos.influxdata.com/influxdata-archive.key
    dest: /etc/apt/trusted.gpg.d/influxdb.asc

- name:  Add InfluxDB repository
  apt_repository:
    repo:  "deb [signed-by=/etc/apt/trusted.gpg.d/influxdb.asc] https://repos.influxdata.com/ubuntu jammy stable"
    state: present
    update_cache: yes

# Grafana
- name: Import Grafana GPG signing key
  get_url: 
    url: https://apt.grafana.com/gpg.key 
    dest: /etc/apt/trusted.gpg.d/grafana.asc

- name: Add Grafana repository
  apt_repository:
    repo: 'deb [signed-by=/etc/apt/trusted.gpg.d/grafana.asc] https://apt.grafana.com stable main'
    state: present
    update_cache: yes


- name: Install packages with no config
  become: true
  become_user: root
  package:
    state: present
    name: "{{ item }}"
  loop:
    - influxdb2
    - telegraf
    - grafana

- name: Enable Influx service
  ansible.builtin.systemd:
    state: started
    enabled: true
    name: influxdb


- name: setup influx
  command: influx setup -b {{ influx_bucket_name }} -o {{ influx_org_name }} -u {{ influx_user_name }} -p {{ influx_password }}  -t {{ influx_token }} -r 0 -f
  ignore_errors: true
 
- name: setup telegraf
  template:
    src: "telegraf.conf.j2"
    dest: /etc/telegraf/telegraf.conf
    owner: root
    group: root

- name: Enable Influx service
  ansible.builtin.systemd:
    state: started
    enabled: true
    name: telegraf


